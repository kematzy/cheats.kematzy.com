  <!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Plugins - Sequel ORM | Cheats by Kematzy</title>

    <link rel="stylesheet" href="../../assets/css/styles.css">
    <link rel="stylesheet" href="../../assets/css/pygment_trac.css">
    <script src="../../assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  
  <body>
    <div class="container">
            
      <nav class="navbar navbar-default">
  <div class="container-fluid row">
    
    <div class="navbar-header col-md-6">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="navbar-brand">
        <h1><a href="/">Cheats by Kematzy</a></h1>
        <p>A personal collection of Cheatsheets</p>
      </div>
    </div>
    
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse col-md-6" id="header-nav">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/">HOME <span class="sr-only">(current)</span></a></li>
        <li><a href="/toc.html">Table of Contents</a></li>
        <li><a href="/about.html">About</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

      
      


<div class="row">
  <div class="col-md-12">
    <ol class="breadcrumb">
      <li><a href="/">Home</a></li>
      
        
        <li><a href="/ruby/">Ruby</a></li>
      
        
        <li><a href="/ruby/sequel/">Sequel</a></li>
      
        
        <li><a href="/ruby/sequel/plugins.html">Plugins</a></li>
      
    </ol>
  </div>
</div>

      
      <section>
        <h1>Ruby / Sequel ORM / Plugins</h1>

<hr>

<h2>Schema</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:schema</span><span class="p">)</span>

 <span class="c1"># only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:schema</span>
<span class="k">end</span></code></pre></div>

<hr>

<h2>ValidationHelpers</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:validation_helpers</span><span class="p">)</span>

 <span class="c1"># only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:validation_helpers</span>
<span class="k">end</span></code></pre></div>

<hr>

<h2>Timestamp</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:timestamps</span><span class="p">)</span>

 <span class="c1"># only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:timestamps</span>
<span class="k">end</span></code></pre></div>

<hr>

<h2>List</h2>

<hr>

<h2>Tree</h2>

<hr>

<h2><a href="https://github.com/kematzy/sequel-paranoid">Paranoid</a></h2>

<p>A plugin for the Ruby ORM Sequel, that allows soft deletion of database entries.</p>

<h3>Basics</h3>

<p>In order to use the paranoid plugin in the very basic version, just add it your model like this:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:paranoid</span><span class="p">)</span>

 <span class="c1"># affects only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:paranoid</span>
<span class="k">end</span></code></pre></div>

<p>This will assume that you have a column <code>deleted_at</code>, which gets filled with the current timestamp once the model gets destroyed:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">instance</span> <span class="o">=</span> <span class="no">ParanoidModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span><span class="p">)</span>

<span class="n">instance</span><span class="o">.</span><span class="n">deleted?</span>   <span class="c1"># =&gt; false</span>
<span class="n">instance</span><span class="o">.</span><span class="n">deleted_at</span> <span class="c1"># =&gt; nil</span>

<span class="n">instance</span><span class="o">.</span><span class="n">destroy</span>

<span class="n">instance</span><span class="o">.</span><span class="n">deleted?</span>   <span class="c1"># =&gt; true</span>
<span class="n">instance</span><span class="o">.</span><span class="n">deleted_at</span> <span class="c1"># =&gt; current timestamp</span></code></pre></div>

<h3>Reading the data</h3>

<p>By default the plugin will not change the way scopes have been working. </p>

<p>So if you want to take the deletion state of an entry into account you can use the following dataset filters:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ParanoidModel</span><span class="o">.</span><span class="n">present</span><span class="o">.</span><span class="n">all</span>      <span class="c1"># =&gt; Will return all the non-deleted entries from the db.</span>
<span class="no">ParanoidModel</span><span class="o">.</span><span class="n">deleted</span><span class="o">.</span><span class="n">all</span>      <span class="c1"># =&gt; Will return all the deleted entries from the db.</span>
<span class="no">ParanoidModel</span><span class="o">.</span><span class="n">with_deleted</span><span class="o">.</span><span class="n">all</span> <span class="c1"># =&gt; Will ignore the deletion state (and is the default).</span></code></pre></div>

<h3>Renaming the deletion timestamp columns</h3>

<p>If you don&#39;t want to use the default column name <code>deleted_at</code>, you can easily rename that column:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ParanoidModel</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:paranoid</span><span class="p">,</span> <span class="ss">:deleted_at_field_name</span> <span class="o">=&gt;</span> <span class="ss">:destroyed_at</span>
<span class="k">end</span>

<span class="n">instance</span> <span class="o">=</span> <span class="no">ParanoidModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>

<span class="n">instance</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">instance</span><span class="o">.</span><span class="n">destroyed_at</span> <span class="c1"># =&gt; current timestamp</span></code></pre></div>

<h3>Enabling the non-deleted default scope</h3>

<p>In order to exclude deleted entries by default from any query, you can enable an option in the plugin. One major reason for don&#39;t enabling it by default is the fact, that associations are kinda broken, when you want to load also deleted associated instances:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ParanoidModel</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:paranoid</span><span class="p">,</span> <span class="ss">:enable_default_scope</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">one_to_many</span> <span class="ss">:child_models</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AnotherModel</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:paranoid</span>
  <span class="n">many_to_one</span> <span class="ss">:paranoid_model</span>
<span class="k">end</span>

 <span class="c1"># create some dummy data</span>

<span class="n">parent1</span> <span class="o">=</span> <span class="no">ParanoidModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="n">parent2</span> <span class="o">=</span> <span class="no">ParanoidModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>

<span class="n">child1</span>  <span class="o">=</span> <span class="no">ChildModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="n">child2</span>  <span class="o">=</span> <span class="no">ChildModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">child3</span>  <span class="o">=</span> <span class="no">ChildModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:something</span> <span class="o">=&gt;</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>

<span class="n">parent1</span><span class="o">.</span><span class="n">add_child_model</span><span class="p">(</span><span class="n">child1</span><span class="p">)</span>
<span class="n">parent1</span><span class="o">.</span><span class="n">add_child_model</span><span class="p">(</span><span class="n">child2</span><span class="p">)</span>
<span class="n">parent2</span><span class="o">.</span><span class="n">add_child_model</span><span class="p">(</span><span class="n">child3</span><span class="p">)</span>

 <span class="c1"># destroy one of the children</span>

<span class="n">child1</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">child1</span><span class="o">.</span><span class="n">deleted?</span> <span class="c1"># =&gt; true</span>

 <span class="c1"># load the children</span>

<span class="no">ChildModel</span><span class="o">.</span><span class="n">all</span>                              <span class="c1"># =&gt; [child2, child3] (works as expected)</span>
<span class="no">ChildModel</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">unfiltered</span><span class="o">.</span><span class="n">all</span>           <span class="c1"># =&gt; [child1, child2, child3] (works as expected)</span>

<span class="n">parent1</span><span class="o">.</span><span class="n">child_models_dataset</span><span class="o">.</span><span class="n">all</span>            <span class="c1"># =&gt; [child2] (works as expected)</span>
<span class="n">parent1</span><span class="o">.</span><span class="n">child_models_dataset</span><span class="o">.</span><span class="n">unfiltered</span><span class="o">.</span><span class="n">all</span> <span class="c1"># =&gt; [child1, child2, child3] (broken)</span></code></pre></div>

<p>Note that <strong>the last command is broken</strong>, as <code>child3</code> is not associated with <code>parent1</code>. The reason for that is <code>unfiltered</code>, which will not only remove the <code>deleted_at</code> check but also the association condition of the query.</p>

<hr>

<h2>JSON Serializer</h2>

<p>Add JSON output capability to all model instances</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:json_serializer</span><span class="p">)</span>

 <span class="c1"># affects only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:json_serializer</span>
<span class="k">end</span></code></pre></div>

<hr>

<h2>XML Serializer</h2>

<p>Add XML output capability to all model instances</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># affect all models</span>
<span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:xml_serializer</span><span class="p">)</span>

 <span class="c1"># only one model</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:xml_serializer</span>
<span class="k">end</span></code></pre></div>

<hr>

      </section>
      
    </div>
    
    
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->    
  </body>
</html>