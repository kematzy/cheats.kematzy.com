  <!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Incoming! - Gems - Ruby | Cheats by Kematzy</title>

    <link rel="stylesheet" href="/assets/css/styles.css">
    <!-- <link rel="stylesheet" href="../../assets/css/-pygment_trac.css"> -->
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>


  <body>
    <div id="page" class="container">

      <nav id="header" class="navbar navbar-default">
  <div class="container-fluid row">

    <div class="navbar-header col-md-6">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="navbar-brand">
        <h1><a href="/">Cheats by Kematzy</a></h1>
        <p>A personal collection of Cheatsheets</p>
      </div>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse col-md-6" id="header-nav">
      <ul class="nav navbar-nav">
      
        
          
        <li class="">
          <a href="/index.html" title="back to the homepage">Home</a>
        </li>
        
        
          
        <li class="">
          <a href="/toc.html" title="full table of contents for this website">Table of Contents</a>
        </li>
        
        
          
        <li class="">
          <a href="/about.html" title="find out more information about this website">About</a>
        </li>
        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>


      


<div id="breadcrumbs" class="row">
  <div class="col-md-12">
    <ol class="breadcrumb">
      <li><a href="/">Home</a></li>
      
        
        <li><a href="/ruby/">Ruby</a></li>
      
        
        <li><a href="/ruby/gems/">Gems</a></li>
      
        
        <li><a href="/ruby/gems/incoming.html">Incoming</a></li>
      
    </ol>
  </div>
</div>


      <div id="page-contents" class="row">

        <div class="col-md-12">
          <h1 id="ruby-gems-incoming">Ruby / Gems / Incoming!</h1>

<hr>

<div id="toc"></div>

<hr>

<h2 id="introduction">Introduction</h2>

<p>Receive email in your Rack apps.</p>

<p>Incoming! receives a <code>Rack::Request</code> and hands you a <a href="https://github.com/mikel/mail/"><code>Mail::Message</code></a>, much
like <code>ActionMailer::Base.receive</code> does with a raw email. </p>

<p>We currently support the following services:</p>

<ul>
<li>SendGrid</li>
<li>Mailgun</li>
<li>Postmark</li>
<li>CloudMailin</li>
<li>Mandrill</li>
<li>Any mail server capable of routing messages to a system command</li>
</ul>

<p>Brought to you by :zap: <strong>Honeybadger.io</strong>, painless <a href="https://www.honeybadger.io/">Rails exception tracking</a>.</p>

<hr>

<h2 id="installation">Installation</h2>

<ol>
<li>Add Incoming! to your Gemfile and run <code>bundle install</code>:</li>
</ol>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">gem &#39;incoming&#39;</code></pre></div>

<ol>
<li><p>Create a new class to receive emails (see examples below)</p></li>
<li><p>Implement an HTTP endpoint to receive HTTP post hooks, and pass the
request to your receiver. (see examples below)</p></li>
</ol>

<hr>

<h2 id="sendgrid-example">SendGrid example</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::SendGrid
  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<p><a href="http://sendgrid.com/docs/API_Reference/Webhooks/parse.html">Sendgrid API reference</a></p>

<hr>

<h2 id="mailgun-example">Mailgun example</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::Mailgun
  setup :api_key =&gt; &#39;asdf&#39;

  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<p><a href="http://documentation.mailgun.net/user_manual.html#receiving-messages">Mailgun API reference</a></p>

<hr>

<h2 id="postmark-example">Postmark example</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::Postmark
  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<p><a href="http://developer.postmarkapp.com/developer-inbound.html">Postmark API reference</a></p>

<hr>

<h2 id="cloudmailin-example">CloudMailin example</h2>

<p>Use the Raw Format when setting up your address target.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::CloudMailin
  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<p><a href="http://docs.cloudmailin.com/http_post_formats/">CloudMailin API reference</a></p>

<hr>

<h2 id="mandrill-example">Mandrill example</h2>

<p>Mandrill is capable of sending multiple events in a single webhook, so the Mandrill strategy works a 
bit differently than the others. </p>

<p>Namely, the <code>.receive</code> method returns an Array of return values from your <code>#receive</code> method for each 
inbound event in the payload. Otherwise, the implementation is the same:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::Mandrill
  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; [&#39;Got message from whoever@wherever.com with subject &quot;hello world&quot;&#39;, &#39;...&#39;]</code></pre></div>

<p><a href="http://help.mandrill.com/entries/22092308-What-is-the-format-of-inbound-email-webhooks-">Mandrill API reference</a></p>

<hr>

<h2 id="postfix-example">Postfix example</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::HTTPPost
  setup :secret =&gt; &#39;6d7e5337a0cd69f52c3fcf9f5af438b1&#39;

  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"># /etc/postfix/virtual
  @example.com http_post

  # /etc/mail/aliases
  http_post: &quot;|http_post -s 6d7e5337a0cd69f52c3fcf9f5af438b1 http://www.example.com/emails&quot;</code></pre></div>

<hr>

<h2 id="qmail-example">Qmail example:</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">class EmailReceiver &lt; Incoming::Strategies::HTTPPost
  setup :secret =&gt; &#39;6d7e5337a0cd69f52c3fcf9f5af438b1&#39;

  def receive(mail)
    %(Got message from #{mail.to.first} with subject &quot;#{mail.subject}&quot;)
  end
end

req = Rack::Request.new(env)
result = EmailReceiver.receive(req) # =&gt; Got message from whoever@wherever.com with subject &quot;hello world&quot;</code></pre></div>

<p>To setup a <em>global</em> incoming email alias:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"># /var/qmail/alias/.qmail-whoever - mails to whoever@ will be delivered to this alias.
 |http_post -s 6d7e5337a0cd69f52c3fcf9f5af438b1 http://www.example.com/emails</code></pre></div>

<p>Domain-specific incoming aliases can be set as follows:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">#/var/qmail/control/virtualdomains
 example.com:example

 #~example/.qmail-whoever
 |http_post -s 6d7e5337a0cd69f52c3fcf9f5af438b1 http://www.example.com/emails</code></pre></div>

<p>Now mails to <code>whoever@example.com</code> will be posted to the corresponding URL above. To post all mails for <code>example.com</code>, just add the above line to <code>~example/.qmail-default</code>.</p>

<hr>

<h2 id="example-rails-controller">Example Rails controller</h2>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"># app/controllers/emails_controller.rb
 class EmailsController &lt; ActionController::Base
   def create
     if EmailReceiver.receive(request)
       render :json =&gt; { :status =&gt; &#39;ok&#39; }
     else
       render :json =&gt; { :status =&gt; &#39;rejected&#39; }, :status =&gt; 403
     end
   end
 end</code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"># config/routes.rb
 Rails.application.routes.draw do
   post &#39;/emails&#39; =&gt; &#39;emails#create&#39;
 end</code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"># spec/controllers/emails_controller_spec.rb
 require &#39;spec_helper&#39;
 
 describe EmailsController, &#39;#create&#39; do
   it &#39;responds with success when request is valid&#39; do
     EmailReceiver.should_receive(:receive).and_return(true)
     post :create
     response.should be_success
     response.body.should eq &#39;{&quot;status&quot;:&quot;ok&quot;}&#39;
   end
 
   it &#39;responds with 403 when request is invalid&#39; do
     EmailReceiver.should_receive(:receive).and_return(false)
     post :create
     response.status.should eq 403
     response.body.should eq &#39;{&quot;status&quot;:&quot;rejected&quot;}&#39;
   end
 end</code></pre></div>

<hr>

<h2 id="todo">TODO</h2>

<ol>
<li>Provide authentication for all strategies where possible (currently
only Mailgun requests are authenticated.)</li>
</ol>

<hr>

<h2 id="license">License</h2>

<p>Incoming! is Copyright 2013 © Joshua Wood and Honeybadger Industries LLC. It is free software, and
may be redistributed under the terms specified in the MIT-LICENSE file.</p>

        </div>

      </div>

      <div id="footer" class="row">
  <div class="col-md-12">
    <p>Project maintained by <a href="https://github.com/kematzy">kematzy</a></p>
    <p>Hosted on GitHub Pages &mdash; Design based upon a theme created by <a href="https://github.com/orderedlist">orderedlist</a></p>
  </div>
</div>


    </div>

    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    <script src="../../assets/js/jquery-2.1.3.min.js"></script>
    <script src="../../assets/js/bootstrap.min.js"></script>
    <script src="../../assets/js/highlight.pack.js"></script>
    <script src="../../assets/js/toc.js"></script>
    <script src="../../assets/js/anchor.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
      $(document).ready(function() {
        
        // style the tables a bit better
        $('table').addClass('table table-bordered table-hover');
        // create a TOC
        $('#toc').toc({ listType: 'ul',  headers: 'h2, h3', showEffect: 'slideDown' });
        // add anchors & permalinks
        anchors.add('h1, h2, h3, h4');
        
        // $('.clickable-header').click(function({
        //
        // }));
      });
    </script>
  </body>
</html>
